?car::Anova
library(survival)
library(dplyr)
library(survminer)
library(ggplot2)
library(bshazard)
library(readr)
natality <- read_csv("natality2018_rmph.csv")
setwd("~/Library/CloudStorage/OneDrive-UniversityofSaskatchewan/USask/Courses/F2025/Lectures/Unit 3_Cox PH Model")
natality <- read_csv("natality2018_rmph.csv")
dim(natality)
natality %>%
select(gestage37, preterm01, MAGER, MRACEHISP, RF_PPTERM, RF_CESAR) %>%
head(5)
is.numeric(natality$gestage37)
# summary of event variable
summary(natality$gestage37)
# summary of outcome/event indicator
table(natality$preterm01, useNA = "ifany")
#library(survival) # we need 'survival' package to run the 'survfit' function.
surv.fit <- survfit(Surv(gestage37, preterm01) ~ 1, data = natality)
print(summary(surv.fit), digits = 3)
# Plot the survival functions
plot(surv.fit, xlab = "Gestational age (weeks)", ylab = "Survival probability",
xlim = c(16, 37), ylim = c(0.85, 1),
mark.time = T, # Identify censored times
xaxt = "n",    # Suppress the x-axis so we can customize it
conf.int = T) # provide confidence interval
axis(1, at = c(seq(17, 36, 3), 37)) # Customize location of tick marks
# First, compute the KM estimate of survival.
surv.fit1 <- survfit(Surv(gestage37, preterm01) ~ MRACEHISP, data = natality)
surv.fit1
plot(surv.fit1,
xlab = "Gestational age (weeks)", ylab = "Survival probability",
main="Survival functions for time to preterm birth by race/ethnicity",
xlim = c(17, 37), ylim = c(0.75, 1),
conf.int = F, mark.time = F,
lty = 1:4) # 4 groups
# Add c(1,3,4,2) in two places to re-order the legend to match
# the ordering of the lines at 37 weeks
legend(20, 0.95,
# Inside c(), the ordering is the same as the order shown in surv.fit1
levels(as.factor(natality$MRACEHISP))[c(1,3,4,2)],
lty = c(1,3,4,2),
title = "Mother's Race/Ethnicity")
coxph.fit<- coxph(Surv(gestage37, preterm01) ~ MRACEHISP,
data = natality)
summary(coxph.fit)
head(natality)
coxph.fit2 <- coxph(Surv(gestage37, preterm01) ~ MAGER,
data = natality)
summary(coxph.fit2)
head(natality)
natality %>%
select(gestage37, preterm01, MAGER, MRACEHISP, RF_PPTERM, RF_CESAR) %>%
head(5)
is.numeric(natality$gestage37)
head(natality)
natality.complete <- natality %>%
select(gestage37, preterm01, RF_PPTERM, MAGER, MRACEHISP, DMAR) %>%
drop_na()
?drop_na
library(tidyr)
natality.complete <- natality %>%
select(gestage37, preterm01, RF_PPTERM, MAGER, MRACEHISP, DMAR) %>%
drop_na()
head(natality.complete)
coxph.fit.unadj <- coxph(Surv(gestage37, preterm01) ~ RF_PPTERM,
data = natality.complete)
cbind("HR"      = exp(summary(coxph.fit.unadj)$coef[, "coef"]),
exp(confint(coxph.fit.unadj)),
"p-value" = summary(coxph.fit.unadj)$coef[, "Pr(>|z|)"])
summary(coxph.fit.unadj)
coxph.fit.adj <- coxph(Surv(gestage37, preterm01) ~ RF_PPTERM + MAGER +
MRACEHISP + DMAR, data = natality.complete)
cbind("AHR"      = exp(summary(coxph.fit.adj)$coef[, "coef"]),
exp(confint(coxph.fit.adj)),
"p-value"  = summary(coxph.fit.adj)$coef[, "Pr(>|z|)"])
# Multiple df p-values
car::Anova(coxph.fit.adj, type = 3, test.statistic = "Wald")
head(
model.matrix(coxph.fit.adj)
)
model.matrix(coxph.fit.adj)[, "RF_PPTERMYes"]
ph_test <- cox.zph(coxph.fit.adj)
print(ph_test)
plot(ph_test)
# Extract Schoenfeld residuals
resid_schoenfeld <- residuals(coxph.fit.adj, type = "schoenfeld")
head(resid_schoenfeld)
plot(resid_schoenfeld[, "MAGER"], main = "Schoenfeld Residuals for Age", ylab = "Residuals", xlab = "Time")
abline(h = 0, col = "red")
par(mfrow=c(2,3))
plot(ph_test)
class(natality$MRACEHISP)
coxph.fit.adj <- coxph(Surv(gestage37, preterm01) ~ RF_PPTERM + MAGER +
factor(MRACEHISP) + DMAR, data = natality.complete)
# Test proportional hazards assumption
ph_test <- cox.zph(coxph.fit.adj)
print(ph_test)
coxph.fit.adj <- coxph(Surv(gestage37, preterm01) ~ RF_PPTERM + MAGER +
as.factor(MRACEHISP) + DMAR, data = natality.complete)
# Test proportional hazards assumption
ph_test <- cox.zph(coxph.fit.adj)
print(ph_test)
as.factor(MRACEHISP)
natality.complete$MRACEHISP<- as.factor(natality.complete$MRACEHISP)
class(natality.complete$MRACEHISP)
table(natality.complete$MRACEHISP)
natality.complete$MRACEHISP<- as.factor(natality.complete$MRACEHISP)
# Fir the adjusted coxph model
coxph.fit.adj <- coxph(Surv(gestage37, preterm01) ~ RF_PPTERM + MAGER +
MRACEHISP + DMAR, data = natality.complete)
# Test proportional hazards assumption
ph_test <- cox.zph(coxph.fit.adj)
print(ph_test)
set.seed(42)
n <- 150
time <- rexp(n, rate = 0.05)
status <- sample(0:1, n, replace = TRUE)
age <- rnorm(n, mean = 60, sd = 12)
# Create a 3-level categorical variable: treatment group
treatment <- sample(c("A", "B", "C"), n, replace = TRUE)
treatment <- factor(treatment)
# Combine into a data frame
sim_data <- data.frame(time, status, age, treatment)
sim_data
cox_model <- coxph(Surv(time, status) ~ age + treatment, data = sim_data)
summary(cox_model)
summarise(coxph.fit.adj)
summary(coxph.fit.adj)
class(sim_data$treatment)
ph_test <- cox.zph(cox_model)
print(ph_test)
plot(ph_test)
set.seed(42)
n <- 150
time <- rexp(n, rate = 0.05)
status <- sample(0:1, n, replace = TRUE)
age <- rnorm(n, mean = 60, sd = 12)
# Create a 3-level categorical variable
treatment <- factor(sample(c("A", "B", "C"), n, replace = TRUE))
# Manually create dummy variables
treatmentB <- ifelse(treatment == "B", 1, 0)
treatmentC <- ifelse(treatment == "C", 1, 0)
# Combine into a data frame
sim_data <- data.frame(time, status, age, treatmentB, treatmentC)
cox_model <- coxph(Surv(time, status) ~ age + treatmentB + treatmentC, data = sim_data)
summary(cox_model)
ph_test <- cox.zph(cox_model)
print(ph_test)
plot(ph_test)
table(natality.complete$MRACEHISP)
# Manually create dummy variables
natality.complete <- natality.complete %>%
mutate(
race_NHBlack <- ifelse(MRACEHISP == "NH Black", 1, 0),
race_NHOther <- ifelse(treatment == "NH Other", 1, 0),
race_Hispanic <- ifelse(treatment == "NH White", 1, 0)
)
MRACEHISP == "NH Black"
natality.complete$MRACEHISP == "NH Black"
natality.complete <- natality.complete %>%
mutate(
race_NHBlack <- ifelse(MRACEHISP == "NH Black", 1, 0),
race_NHOther <- ifelse(MRACEHISP == "NH Other", 1, 0),
race_Hispanic <- ifelse(MRACEHISP == "NH White", 1, 0)
)
# Manually create dummy variables
natality.complete <- natality.complete %>%
mutate(
race_NHBlack <- ifelse(MRACEHISP == "NH Black", 1, 0),
race_NHOther <- ifelse(MRACEHISP == "NH Other", 1, 0),
race_Hispanic <- ifelse(MRACEHISP == "Hispanic", 1, 0)
)
table(natality.complete$MRACEHISP)
coxph.fit.adj <- coxph(Surv(gestage37, preterm01) ~ RF_PPTERM + MAGER +
race_NHBlack +race_NHOther + race_Hispanic + DMAR,
data = natality.complete)
# Manually create dummy variables
natality.complete <- natality.complete %>%
mutate(
race_NHBlack <- ifelse(MRACEHISP == "NH Black", 1, 0),
race_NHOther <- ifelse(MRACEHISP == "NH Other", 1, 0),
race_Hispanic <- ifelse(MRACEHISP == "Hispanic", 1, 0)
)
coxph.fit.adj <- coxph(Surv(gestage37, preterm01) ~ RF_PPTERM + MAGER +
race_NHBlack +race_NHOther + race_Hispanic + DMAR,
data = natality.complete)
head(natality.complete)
View(natality.complete)
natality.complete <- natality.complete %>%
mutate(
race_NHBlack = ifelse(MRACEHISP == "NH Black", 1, 0),
race_NHOther = ifelse(MRACEHISP == "NH Other", 1, 0),
race_Hispanic = ifelse(MRACEHISP == "Hispanic", 1, 0)
)
# Fir the adjusted coxph model
coxph.fit.adj <- coxph(Surv(gestage37, preterm01) ~ RF_PPTERM + MAGER +
race_NHBlack +race_NHOther + race_Hispanic + DMAR,
data = natality.complete)
# Test proportional hazards assumption
ph_test <- cox.zph(coxph.fit.adj)
print(ph_test)
View(natality)
View(natality.complete)
setwd("~/Library/CloudStorage/OneDrive-UniversityofSaskatchewan/USask/Courses/F2025/Lectures/Unit 3_Cox PH Model")
library(survival)
library(dplyr)
library(tidyr)
library(survminer)
library(ggplot2)
library(bshazard)
library(readr)
natality <- read_csv("natality2018_rmph.csv")
dim(natality)
View(natality)
natality %>%
select(gestage37, preterm01, MAGER, MRACEHISP, RF_PPTERM, RF_CESAR) %>%
head(5)
is.numeric(natality$gestage37)
summary(natality$gestage37)
# summary of outcome/event indicator
table(natality$preterm01, useNA = "ifany")
surv.fit <- survfit(Surv(gestage37, preterm01) ~ 1, data = natality)
print(summary(surv.fit), digits = 3)
survfit(Surv(gestage37, preterm01) ~ 1)
natality %>% survfit(Surv(gestage37, preterm01) ~ 1)
natality%>%survfit(Surv(gestage37, preterm01) ~ 1)
surv.fit <- survfit(Surv(gestage37, preterm01) ~ 1, data = natality)
print(summary(surv.fit), digits = 3)
# Plot the survival functions
plot(surv.fit, xlab = "Gestational age (weeks)", ylab = "Survival probability",
xlim = c(16, 37), ylim = c(0.85, 1),
mark.time = T, # Identify censored times
xaxt = "n",    # Suppress the x-axis so we can customize it
conf.int = T) # provide confidence interval
axis(1, at = c(seq(17, 36, 3), 37)) # Customize location of tick marks
surv.fit1 <- survfit(Surv(gestage37, preterm01) ~ MRACEHISP, data = natality)
surv.fit1
plot(surv.fit1,
xlab = "Gestational age (weeks)", ylab = "Survival probability",
main="Survival functions for time to preterm birth by race/ethnicity",
xlim = c(17, 37), ylim = c(0.75, 1),
conf.int = F, mark.time = F,
lty = 1:4) # 4 groups
# Add c(1,3,4,2) in two places to re-order the legend to match
# the ordering of the lines at 37 weeks
legend(20, 0.95,
# Inside c(), the ordering is the same as the order shown in surv.fit1
levels(as.factor(natality$MRACEHISP))[c(1,3,4,2)],
lty = c(1,3,4,2),
title = "Mother's Race/Ethnicity")
survdiff.LR <- survdiff(Surv(gestage37, preterm01) ~ MRACEHISP,
data = natality)
survdiff.LR
pchisq(survdiff.LR$chisq,
df=length(levels(as.factor(natality$MRACEHISP))) - 1,
lower.tail=F)
coxph.fit<- coxph(Surv(gestage37, preterm01) ~ MRACEHISP,
data = natality)
summary(coxph.fit)
summary(coxph.fit)$coef
cbind("HR" = exp(summary(coxph.fit)$coef[, "coef"]),
exp(confint(coxph.fit)),
"p-value" = summary(coxph.fit)$coef[, "Pr(>|z|)"])
# Wald tests for categorical variables with more than two levels.
car::Anova(coxph.fit, type = 3, test.statistic = "Wald")
coxph.fit2 <- coxph(Surv(gestage37, preterm01) ~ MAGER,
data = natality)
summary(coxph.fit2)
natality.complete <- natality %>%
select(gestage37, preterm01, RF_PPTERM, MAGER, MRACEHISP, DMAR) %>%
drop_na() # remove the missing values if any
# Unadjusted model
coxph.fit.unadj <- coxph(Surv(gestage37, preterm01) ~ RF_PPTERM,
data = natality.complete)
# HR, 95% CI, p-value
cbind("HR"      = exp(summary(coxph.fit.unadj)$coef[, "coef"]),
exp(confint(coxph.fit.unadj)),
"p-value" = summary(coxph.fit.unadj)$coef[, "Pr(>|z|)"])
# Adjusted
coxph.fit.adj <- coxph(Surv(gestage37, preterm01) ~ RF_PPTERM + MAGER +
MRACEHISP + DMAR, data = natality.complete)
# AHRs, 95% CIs, p-values
cbind("AHR"      = exp(summary(coxph.fit.adj)$coef[, "coef"]),
exp(confint(coxph.fit.adj)),
"p-value"  = summary(coxph.fit.adj)$coef[, "Pr(>|z|)"])
car::Anova(coxph.fit.adj, type = 3, test.statistic = "Wald")
# Fir the adjusted coxph model
coxph.fit.adj <- coxph(Surv(gestage37, preterm01) ~ RF_PPTERM + MAGER +
race_NHBlack +race_NHOther + race_Hispanic + DMAR,
data = natality.complete)
table( natality.complete$MRACEHISP)
natality.complete <- natality.complete %>%
mutate(
race_NHBlack = ifelse(MRACEHISP == "NH Black", 1, 0),
race_NHOther = ifelse(MRACEHISP == "NH Other", 1, 0),
race_Hispanic = ifelse(MRACEHISP == "Hispanic", 1, 0)
)
View(natality.complete)
coxph.fit.adj <- coxph(Surv(gestage37, preterm01) ~ RF_PPTERM + MAGER +
race_NHBlack +race_NHOther + race_Hispanic + DMAR,
data = natality.complete)
ph_test <- cox.zph(coxph.fit.adj)
print(ph_test)
par(mfrow=c(2,3))
plot(ph_test)
## Manual comparison: Visual inspection of residuals
# Extract Schoenfeld residuals
resid_schoenfeld <- residuals(coxph.fit.adj, type = "schoenfeld")
# Plot residuals for 'Mother's age'
par(mfrow=c(1,1))
plot(resid_schoenfeld[, "MAGER"], main = "Schoenfeld Residuals for Age",
ylab = "Residuals", xlab = "Time")
abline(h = 0, col = "red")
